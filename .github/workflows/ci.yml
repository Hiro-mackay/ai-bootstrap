name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect Language
    runs-on: ubuntu-latest
    outputs:
      node: ${{ steps.check.outputs.node }}
      go: ${{ steps.check.outputs.go }}
      python: ${{ steps.check.outputs.python }}
      rust: ${{ steps.check.outputs.rust }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect project language
        id: check
        run: |
          echo "node=$([[ -f package.json ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "go=$([[ -f go.mod ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "python=$([[ -f requirements.txt || -f pyproject.toml || -f setup.py ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "rust=$([[ -f Cargo.toml ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"

  node:
    name: Node.js
    needs: detect
    if: needs.detect.outputs.node == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect package manager
        id: pm
        run: |
          if [[ -f bun.lockb ]]; then
            echo "manager=bun" >> "$GITHUB_OUTPUT"
          elif [[ -f pnpm-lock.yaml ]]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
          elif [[ -f yarn.lock ]]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
          else
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        if: steps.pm.outputs.manager != 'bun'
        uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: ${{ steps.pm.outputs.manager }}

      - name: Setup Bun
        if: steps.pm.outputs.manager == 'bun'
        uses: oven-sh/setup-bun@v2

      - name: Setup pnpm
        if: steps.pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: |
          case "${{ steps.pm.outputs.manager }}" in
            bun)  bun install --frozen-lockfile ;;
            pnpm) pnpm install --frozen-lockfile ;;
            yarn) yarn install --frozen-lockfile ;;
            npm)  npm ci ;;
          esac

      - name: Lint
        run: |
          PM="${{ steps.pm.outputs.manager }}"
          $PM run lint --if-present 2>/dev/null || true

      - name: Test
        run: |
          PM="${{ steps.pm.outputs.manager }}"
          $PM run test --if-present 2>/dev/null || true

  go:
    name: Go
    needs: detect
    if: needs.detect.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest

      - name: Test
        run: go test ./...

  python:
    name: Python
    needs: detect
    if: needs.detect.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version-file: .python-version
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then pip install -r requirements.txt; fi
          if [[ -f pyproject.toml ]]; then pip install .[dev] 2>/dev/null || pip install .; fi

      - name: Lint
        run: |
          pip install ruff
          ruff check .

      - name: Test
        run: |
          if command -v pytest &>/dev/null; then
            pytest
          elif [[ -d tests ]]; then
            python -m unittest discover tests
          fi

  rust:
    name: Rust
    needs: detect
    if: needs.detect.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Lint
        run: |
          cargo fmt --check
          cargo clippy -- -D warnings

      - name: Test
        run: cargo test

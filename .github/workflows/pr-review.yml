name: PR Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          FILES=$(gh pr diff "${{ github.event.pull_request.number }}" --name-only)
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "count=$(echo "$FILES" | wc -l | tr -d ' ')" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(gh pr diff "${{ github.event.pull_request.number }}")
          echo "diff<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------------
      # AI Review Integration Point
      #
      # Replace or extend the step below with your preferred AI review
      # tool. Examples:
      #
      #   - Claude: use Anthropic API with the diff as input
      #   - OpenAI: use ChatGPT API for code review
      #   - CodeRabbit: uses/coderabbitai/ai-pr-reviewer
      #   - Custom: call any HTTP endpoint with the diff payload
      #
      # Required secrets (configure in repository settings):
      #   ANTHROPIC_API_KEY  - for Claude-based reviews
      #   OPENAI_API_KEY     - for OpenAI-based reviews
      # ---------------------------------------------------------------
      - name: AI Review (placeholder)
        run: |
          echo "AI review integration point"
          echo "Changed files: ${{ steps.changed.outputs.count }}"
          echo ""
          echo "To enable AI-powered reviews, configure one of:"
          echo "  - ANTHROPIC_API_KEY secret for Claude"
          echo "  - OPENAI_API_KEY secret for OpenAI"
          echo "  - Or integrate your preferred AI review tool"

      - name: Post review summary
        if: always()
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" \
            --body "**PR Review Summary**

          Files changed: ${{ steps.changed.outputs.count }}

          > Configure AI-powered reviews by adding your API keys to repository secrets.
          > See \`.github/workflows/pr-review.yml\` for setup instructions."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
